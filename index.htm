<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Brainrot / Rot Scale Clinical+ (Sequential)</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#14161d; --panel2:#0f121a; --ink:#e8e8ea; --muted:#a7abb7;
      --line:#232635; --accent:#7aa2ff; --good:#6ee7b7; --warn:#fbbf24; --bad:#f87171;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--ink);}
    header{padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,12,16,.92);backdrop-filter:blur(6px);z-index:10}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted)}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button{background:#0f1118;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px}
    button{cursor:pointer;font-weight:600}
    button.primary{background:var(--accent);border-color:transparent;color:#0b0c10}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .progress{height:8px;background:#0f1118;border:1px solid var(--line);border-radius:99px;overflow:hidden}
    .progress > div{height:100%;background:var(--accent);width:0%}
    .q{padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--panel2);margin:8px 0}
    .q .text{font-size:15px;line-height:1.35}
    .options{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .opt{flex:1 1 120px;min-width:110px}
    .opt label{display:block;padding:8px;border:1px solid var(--line);border-radius:10px;text-align:center;background:#0f1118;cursor:pointer}
    .opt input{display:none}
    .opt input:checked + label{outline:2px solid var(--accent);background:#151a27}
    .sectionTitle{display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px;padding:2px 8px;border-radius:99px;background:#0f1118;border:1px solid var(--line)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .hidden{display:none}
    .validBox{border:1px dashed #2a2e3f;background:#0f121a;border-radius:12px;padding:10px 12px;font-size:14px;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:99px;font-size:12px;font-weight:700;margin-right:6px}
    .pill.ok{background:rgba(110,231,183,.12);color:var(--good);border:1px solid rgba(110,231,183,.4)}
    .pill.warn{background:rgba(251,191,36,.12);color:var(--warn);border:1px solid rgba(251,191,36,.4)}
    .pill.bad{background:rgba(248,113,113,.12);color:var(--bad);border:1px solid rgba(248,113,113,.4)}

    .taskBox{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--panel2)}
    .taskGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
    .taskCell{height:44px;border-radius:8px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-weight:800;background:#0f1118;cursor:pointer;user-select:none}
    .taskCell.target{outline:2px dashed var(--accent)}
    .taskCell.hit{background:rgba(110,231,183,.12);border-color:rgba(110,231,183,.5)}
    .taskCell.miss{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.5)}

    .stepper{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .step{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .step.active{background:#1a1e2a;border-color:#3a4160}
    .step.done{opacity:.6}
  </style>
</head>

<body>
<header>
  <div class="wrap row" style="justify-content:space-between;">
    <div>
      <h1>Brainrot / Rot Scale Clinical+ (Sequential)</h1>
      <div class="muted" id="subtitle"></div>
    </div>

    <div class="row">
      <select id="langSel">
        <option value="hu">Magyar</option>
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="uk">Українська</option>
      </select>
      <button class="ghost" id="aboutBtn">?</button>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="card hidden" id="aboutCard">
    <b id="aboutTitle"></b>
    <p class="muted" id="aboutText"></p>
  </div>

  <!-- STEP 0: attention task -->
  <div class="card" id="taskCard">
    <div class="sectionTitle">
      <b id="taskTitle"></b>
      <span class="badge" id="taskTimer">30s</span>
    </div>
    <p class="muted" id="taskDesc"></p>

    <div class="taskBox">
      <div class="row" style="justify-content:space-between;">
        <div id="taskStatus" class="muted"></div>
        <div><b id="taskScoreLbl"></b> <span id="taskScore">0</span></div>
      </div>
      <div class="taskGrid" id="taskGrid"></div>

      <div class="row" style="margin-top:8px;">
        <button id="taskStart" class="primary"></button>
        <button id="taskSkip" class="ghost"></button>
        <div style="flex:1"></div>
        <button id="taskNext" class="primary" disabled></button>
      </div>
    </div>
  </div>

  <!-- STEP 1..5: questionnaire modules -->
  <div class="card hidden" id="mainCard">
    <div class="sectionTitle">
      <div>
        <b id="mainTitle"></b>
        <div class="stepper" id="stepper"></div>
      </div>
      <span class="badge" id="answeredBadge">0 / 100</span>
    </div>
    <div class="progress" style="margin-top:8px;"><div id="progBar"></div></div>

    <div class="sectionTitle" style="margin-top:10px;">
      <b id="sectionName"></b>
      <span class="badge" id="sectionBadge">0 / 20</span>
    </div>

    <div id="questions"></div>

    <div class="row" style="margin-top:10px;">
      <button id="prevSection" class="ghost"></button>
      <button id="nextSection" class="primary" disabled></button>
    </div>

    <div class="row" style="margin-top:10px;">
      <label class="muted" style="display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="consentBox"/>
        <span id="consentText"></span>
      </label>
      <div style="flex:1"></div>
      <button id="calcBtn" class="primary hidden"></button>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="card hidden" id="resultsCard">
    <b id="resTitle"></b>
    <p class="muted" id="resLine"></p>
    <div id="scoreBig" style="font-size:40px;font-weight:900;margin:6px 0;"></div>
    <div id="catLine" class="badge"></div>

    <div style="margin-top:10px;" id="vibeText"></div>

    <div class="validBox" style="margin-top:10px;">
      <b id="validityTitle"></b>
      <div id="validityText" style="margin-top:6px;"></div>
    </div>

    <div class="grid2" style="margin-top:10px;" id="dimBoxes"></div>
  </div>

</div>

<script>
let LANG="hu";

const I18N = {
  hu:{
    subtitle:"Modulonkénti megjelenítés (figyelemteszt → S → F → H → D → A).",
    aboutTitle:"Mi ez?",
    aboutText:"Ez egy kultúra/viselkedésprofil teszt. A validitás- és figyelemindikátorok a kitöltés megbízhatóságát jelzik – nem diagnózist.",
    taskTitle:"Rapid Focus Task (figyelemteszt)",
    taskDesc:"30 mp alatt kattints minden kiemelt célmezőre (⚡). Nem része a Rot Scale-nek, csak a kitöltés minőségét segíti.",
    taskStart:"Indítás",
    taskSkip:"Kihagyás",
    taskNext:"Tovább a kérdőívhez",
    taskStatusReady:"Készen áll.",
    taskStatusRun:"Fut… kattints a célokra!",
    taskStatusDone:"Kész!",
    taskScoreLbl:"Attention Index:",
    mainTitle:"Kérdőív",
    prev:"Vissza",
    next:"Következő modul",
    finish:"Eredmény",
    consentText:"Beleegyezem, hogy az anonimizált válaszok (pont + itemek) statisztika célra el legyenek küldve.",
    calcBtn:"Pontszám kiszámítása",
    results:{
      title:"Eredmény",
      reliabilityTitle:"Kitöltés megbízhatósága",
      ok:"A válaszaid konzisztensnek tűnnek.",
      warn:"Van némi ellentmondás / bizonytalanság a kitöltésben.",
      bad:"Erős jelek utalnak figyelmetlen vagy random kitöltésre.",
      reasons:{
        fast:"Nagyon gyors kitöltés.",
        straightBad:"Nagyon sok azonos válasz (straightlining).",
        straightWarn:"Sok azonos válasz (straightlining).",
        inconsBad:"Erős ellentmondások a páros tételekben.",
        inconsWarn:"Néhány ellentmondás a páros tételekben.",
        attBad:"Sok figyelem-ellenőrző tétel hibás.",
        attWarn:"Néhány figyelem-ellenőrző tétel hibás.",
        focusLow:"A figyelemteszt pont alacsony."
      }
    },
    dims:{S:"Stimuláció",F:"Fókusz szétesés",H:"Humor/abszurd",D:"Feed/Platform",A:"Anti-Rot"},
    options:["0 – Egyáltalán nem","1 – Ritkán","2 – Néha","3 – Gyakran","4 – Nagyon"],
    categories:{anti:"Anti Rotism",neutral:"Neutral",semi:"Semi-Rot",brain:"Officially Brainrotted",severe:"Severely Brainrotted"}
  },
  en:{
    subtitle:"Sequential modules (attention task → S → F → H → D → A).",
    aboutTitle:"What is this?",
    aboutText:"This is a culture/behavior profile. Validity indicators reflect response quality, not diagnosis.",
    taskTitle:"Rapid Focus Task (attention)",
    taskDesc:"Click all highlighted targets (⚡) within 30 seconds. Not part of Rot Scale; only for response quality.",
    taskStart:"Start",
    taskSkip:"Skip",
    taskNext:"Continue to questionnaire",
    taskStatusReady:"Ready.",
    taskStatusRun:"Running… click targets!",
    taskStatusDone:"Done!",
    taskScoreLbl:"Attention Index:",
    mainTitle:"Questionnaire",
    prev:"Back",
    next:"Next module",
    finish:"Results",
    consentText:"I agree that anonymized answers (score + items) may be sent for statistics.",
    calcBtn:"Calculate score",
    results:{
      title:"Results",
      reliabilityTitle:"Response reliability",
      ok:"Your answers look consistent.",
      warn:"Some inconsistencies detected; treat score as less certain.",
      bad:"Strong signs of random/inattentive responding.",
      reasons:{
        fast:"Very fast completion.",
        straightBad:"Heavy straightlining.",
        straightWarn:"Some straightlining.",
        inconsBad:"Strong inconsistencies on paired items.",
        inconsWarn:"Some inconsistencies on paired items.",
        attBad:"Many attention-check items failed.",
        attWarn:"Some attention-check items failed.",
        focusLow:"Low attention-task score."
      }
    },
    dims:{S:"Stimulation",F:"Fragmented focus",H:"Absurd humor",D:"Feed/Platform",A:"Anti-Rot"},
    options:["0 – Not at all","1 – Rarely","2 – Sometimes","3 – Often","4 – Very much"],
    categories:{anti:"Anti Rotism",neutral:"Neutral",semi:"Semi-Rot",brain:"Officially Brainrotted",severe:"Severely Brainrotted"}
  },
  de:{
    subtitle:"Sequentielle Module (Aufmerksamkeit → S → F → H → D → A).",
    aboutTitle:"Was ist das?",
    aboutText:"Kultur/Verhaltens-Profil. Validität zeigt Antwortqualität, keine Diagnose.",
    taskTitle:"Rapid Focus Task (Aufmerksamkeit)",
    taskDesc:"Klicke alle Ziel-Felder (⚡) in 30 Sekunden. Nicht Teil der Rot Scale.",
    taskStart:"Start",
    taskSkip:"Überspringen",
    taskNext:"Weiter zum Fragebogen",
    taskStatusReady:"Bereit.",
    taskStatusRun:"Läuft… Ziele klicken!",
    taskStatusDone:"Fertig!",
    taskScoreLbl:"Attention Index:",
    mainTitle:"Fragebogen",
    prev:"Zurück",
    next:"Nächstes Modul",
    finish:"Ergebnis",
    consentText:"Ich stimme zu, dass anonymisierte Antworten gesendet werden.",
    calcBtn:"Score berechnen",
    results:{
      title:"Ergebnis", reliabilityTitle:"Antwort-Zuverlässigkeit",
      ok:"Deine Antworten wirken konsistent.",
      warn:"Einige Widersprüche erkannt; Ergebnis weniger sicher.",
      bad:"Starke Hinweise auf zufälliges/unaufmerksames Ausfüllen.",
      reasons:{
        fast:"Sehr schnelle Bearbeitung.",
        straightBad:"Starkes Straightlining.",
        straightWarn:"Etwas Straightlining.",
        inconsBad:"Starke Widersprüche bei Paar-Items.",
        inconsWarn:"Einige Widersprüche bei Paar-Items.",
        attBad:"Viele Aufmerksamkeitschecks falsch.",
        attWarn:"Einige Aufmerksamkeitschecks falsch.",
        focusLow:"Niedriger Aufmerksamkeitstest-Score."
      }
    },
    dims:{S:"Stimulation",F:"Fokus-Fragmentierung",H:"Absurder Humor",D:"Feed/Plattform",A:"Anti-Rot"},
    options:["0 – Gar nicht","1 – Selten","2 – Manchmal","3 – Oft","4 – Sehr"],
    categories:{anti:"Anti Rotism",neutral:"Neutral",semi:"Semi-Rot",brain:"Officially Brainrotted",severe:"Severely Brainrotted"}
  },
  uk:{
    subtitle:"Послідовні модулі (увага → S → F → H → D → A).",
    aboutTitle:"Що це?", aboutText:"Профіль культури/поведінки. Валідність = якість відповідей.",
    taskTitle:"Rapid Focus Task (увага)",
    taskDesc:"Клацни всі цілі (⚡) за 30 секунд. Не впливає на Rot Scale.",
    taskStart:"Старт", taskSkip:"Пропустити", taskNext:"Далі до опитувальника",
    taskStatusReady:"Готово.", taskStatusRun:"Йде… клікай цілі!", taskStatusDone:"Готово!",
    taskScoreLbl:"Attention Index:",
    mainTitle:"Опитувальник",
    prev:"Назад", next:"Наступний модуль", finish:"Результат",
    consentText:"Я згоден/згодна на анонімну відправку відповідей для статистики.",
    calcBtn:"Порахувати бал",
    results:{
      title:"Результат", reliabilityTitle:"Надійність відповідей",
      ok:"Відповіді узгоджені.", warn:"Є деякі суперечності.", bad:"Ознаки випадкового/неуважного заповнення.",
      reasons:{
        fast:"Дуже швидке заповнення.",
        straightBad:"Сильне straightlining.",
        straightWarn:"Є straightlining.",
        inconsBad:"Сильні суперечності.",
        inconsWarn:"Є деякі суперечності.",
        attBad:"Багато помилок у перевірках уваги.",
        attWarn:"Є помилки у перевірках уваги.",
        focusLow:"Низький бал уваги."
      }
    },
    dims:{S:"Стимуляція",F:"Розсіяна увага",H:"Абсурд-гумор",D:"Фід/платформа",A:"Анти-рот"},
    options:["0 – Ні","1 – Рідко","2 – Іноді","3 – Часто","4 – Дуже"],
    categories:{anti:"Anti Rotism",neutral:"Neutral",semi:"Semi-Rot",brain:"Officially Brainrotted",severe:"Severely Brainrotted"}
  }
};

function t(path){
  const parts=path.split(".");
  let cur=I18N[LANG];
  for(const p of parts) cur=cur?.[p];
  return cur ?? path;
}

/* ----------------- BANK: ide másold a saját kérdéseidet ----------------- */
const BANK = {
  S:{items:[
    {hu:"Szeretem, ha sok vizuális inger ér egyszerre (pl. gyors videók, erős effektek).", en:"I like having a lot of visual stimulation at once (e.g., fast videos, strong effects).", de:"Ich mag es, wenn mich viele visuelle Reize gleichzeitig erreichen (z.B. schnelle Videos, starke Effekte).", uk:"Мені подобається багато візуальних стимулів одночасно (швидкі відео, сильні ефекти)."},
    {hu:"Ha valami lassú vagy csendes, hamar unalmassá válik.", en:"If something is slow or quiet, it gets boring quickly.", de:"Wenn etwas langsam oder ruhig ist, wird es schnell langweilig.", uk:"Якщо щось повільне або тихе, мені швидко стає нудно."},
    {hu:"Gyakran több dolgot nézek/hallgatok egyszerre.", en:"I often watch/listen to multiple things at once.", de:"Ich schaue/höre oft mehrere Dinge gleichzeitig.", uk:"Я часто дивлюся/слухаю кілька речей одночасно."},
    {hu:"Szeretek pörgetni olyan tartalmakat is, amik csak pár másodpercesek.", en:"I like scrolling through content that’s only a few seconds long.", de:"Ich scrolle gern durch Inhalte, die nur ein paar Sekunden lang sind.", uk:"Мені подобається гортати дуже короткий контент (кілька секунд)."},
    {hu:"Ha egy videóban túl sok a csend, áttekerem.", en:"If a video has too much silence, I skip ahead.", de:"Wenn in einem Video zu viel Stille ist, spule ich vor.", uk:"Якщо у відео забагато тиші, я перемотую."},
    {hu:"Jobban leköt egy ‘random’ pörgős montázs, mint egy hosszú magyarázat.", en:"A random fast montage holds my attention more than a long explanation.", de:"Ein zufälliger schneller Zusammenschnitt fesselt mich mehr als eine lange Erklärung.", uk:"Швидкий ‘рандомний’ монтаж захоплює мене більше, ніж довге пояснення."},
    {hu:"Szeretek olyan dolgokat nézni, amik nagyon sűrűn váltanak képet/poént.", en:"I like watching things with very rapid cuts/jokes.", de:"Ich sehe gern Dinge, die sehr schnell Bilder/Witze wechseln.", uk:"Мені подобається контент із дуже швидкою зміною кадрів/жартів."},
    {hu:"Ha unatkozom, automatikusan megnyitok valami pörgős appot.", en:"When I’m bored, I automatically open some fast-paced app.", de:"Wenn mir langweilig ist, öffne ich automatisch eine schnelle App.", uk:"Коли мені нудно, я автоматично відкриваю якусь ‘швидку’ програму."},
    {hu:"Szeretem, ha egy tartalom egyszerre vicces és vizuálisan túl van tolva.", en:"I like content that’s both funny and visually over-the-top.", de:"Ich mag Inhalte, die gleichzeitig lustig und visuell übertrieben sind.", uk:"Мені подобається контент, який і смішний, і візуально ‘перебільшений’."},
    {hu:"Ha nincs valami inger, úgy érzem ‘hiányzik valami’.", en:"If there’s no stimulation, I feel like something is missing.", de:"Wenn kein Reiz da ist, fühlt es sich an, als würde etwas fehlen.", uk:"Коли немає стимулу, здається, що ‘чогось бракує’."},
    {hu:"Gyakran eszembe jut egy mém/szöveg random helyzetekben is.", en:"Memes/phrases often pop into my head in random situations.", de:"Memes/Sätze kommen mir oft in zufälligen Situationen in den Sinn.", uk:"Меми/фрази часто спливають у голові в рандомних ситуаціях."},
    {hu:"Szeretem a hirtelen hangokat/effekteket a videókban.", en:"I enjoy sudden sounds/effects in videos.", de:"Ich mag plötzliche Geräusche/Effekte in Videos.", uk:"Мені подобаються раптові звуки/ефекти у відео."},
    {hu:"A ‘túl sok inger’ ritkán zavar, inkább feldob.", en:"Too much stimulation rarely bothers me; it energizes me.", de:"Zu viele Reize stören mich selten; eher begeistern sie mich.", uk:"Забагато стимулів мене рідко дратує — швидше заряджає."},
    {hu:"Néha direkt keresem a káoszos/‘brainrot’ tartalmakat.", en:"Sometimes I deliberately look for chaotic/brainrot content.", de:"Manchmal suche ich gezielt chaotische/brainrot Inhalte.", uk:"Іноді я спеціально шукаю хаотичний/‘brainrot’ контент."},
    {hu:"Szeretem, ha egy tartalom ‘túl gyors’ másoknak.", en:"I like content that is ‘too fast’ for others.", de:"Ich mag Inhalte, die für andere ‘zu schnell’ sind.", uk:"Мені подобається контент, який для інших ‘занадто швидкий’."},
    {hu:"A gyors inger segít, hogy ne unatkozzak.", en:"Fast stimulation helps me avoid boredom.", de:"Schnelle Reize helfen mir, mich nicht zu langweilen.", uk:"Швидкі стимули допомагають мені не нудьгувати."},
    {hu:"Ha valami túl lassan épül fel, elvesztem az érdeklődést.", en:"If something builds too slowly, I lose interest.", de:"Wenn sich etwas zu langsam aufbaut, verliere ich das Interesse.", uk:"Якщо щось розвивається надто повільно, я втрачаю інтерес."},
    {hu:"A pörgős tartalmak után a normál tempó unalmasnak tűnik.", en:"After fast content, normal pace feels boring.", de:"Nach schnellen Inhalten wirkt normales Tempo langweilig.", uk:"Після швидкого контенту нормальний темп здається нудним."},
    {hu:"Szeretem a ‘túl sok minden történik egyszerre’ érzést.", en:"I like the feeling that ‘too much is happening at once’.", de:"Ich mag das Gefühl, dass ‘zu viel gleichzeitig passiert’.", uk:"Мені подобається відчуття, що ‘забагато всього відбувається одночасно’."},
    {hu:"A gyors, hangos, színes tartalom a kedvencem.", en:"Fast, loud, colorful content is my favorite.", de:"Schneller, lauter, bunter Inhalt ist mein Favorit.", uk:"Швидкий, гучний, яскравий контент — мій улюблений."}
  ]},

  F:{items:[
    {hu:"Nehéz hosszabb ideig egy dologra figyelni online.", en:"It’s hard for me to focus on one thing online for a long time.", de:"Es fällt mir schwer, online lange bei einer Sache zu bleiben.", uk:"Мені важко довго зосереджуватися на чомусь одному онлайн."},
    {hu:"Gyakran ugrálok egyik tartalomról a másikra.", en:"I often jump from one piece of content to another.", de:"Ich springe oft von einem Inhalt zum nächsten.", uk:"Я часто перескакую з одного контенту на інший."},
    {hu:"Ha nem fog meg azonnal valami, továbbmegyek.", en:"If something doesn’t grab me immediately, I move on.", de:"Wenn mich etwas nicht sofort packt, gehe ich weiter.", uk:"Якщо щось не ‘зачіпає’ одразу, я йду далі."},
    {hu:"Sokszor félbehagyok videókat/cikkeket.", en:"I often leave videos/articles unfinished.", de:"Ich breche Videos/Artikel oft ab.", uk:"Я часто не додивляюся відео/не дочитую статті."},
    {hu:"Könnyen elkalandozik a figyelmem scrollozás közben.", en:"My attention drifts easily while scrolling.", de:"Meine Aufmerksamkeit schweift beim Scrollen leicht ab.", uk:"Моя увага легко розсіюється під час скролу."},
    {hu:"Néha már nem is emlékszem, mit néztem egy perccel ezelőtt.", en:"Sometimes I don’t even remember what I watched a minute ago.", de:"Manchmal erinnere ich mich kaum, was ich vor einer Minute gesehen habe.", uk:"Іноді я не пам’ятаю, що дивився хвилину тому."},
    {hu:"Ha közben jön egy értesítés, azonnal rákattintok.", en:"If a notification pops up, I click it right away.", de:"Wenn eine Benachrichtigung kommt, klicke ich sofort drauf.", uk:"Якщо приходить сповіщення, я одразу відкриваю."},
    {hu:"Sokszor megnyitok valamit, aztán gyorsan bezárom.", en:"I often open something and quickly close it.", de:"Ich öffne oft etwas und schließe es schnell wieder.", uk:"Я часто щось відкриваю і швидко закриваю."},
    {hu:"Előfordul, hogy több app között pingpongozok.", en:"I sometimes ping-pong between multiple apps.", de:"Manchmal pendle ich zwischen mehreren Apps hin und her.", uk:"Буває, що ‘пінг-понгую’ між кількома додатками."},
    {hu:"Ha egy tartalom túl sokat magyaráz, elvesztem a fonalat.", en:"If content explains too much, I lose the thread.", de:"Wenn etwas zu viel erklärt, verliere ich den Faden.", uk:"Якщо контент занадто довго пояснює, я гублю нитку."},
    {hu:"Néha csak azért pörgetek, mert nem tudom, mit nézzek.", en:"Sometimes I scroll just because I don’t know what to watch.", de:"Manchmal scrolle ich nur, weil ich nicht weiß, was ich ansehen soll.", uk:"Іноді я скролю просто бо не знаю, що дивитися."},
    {hu:"A hosszú, egyenletes tempójú videók kifárasztanak.", en:"Long, steady-paced videos tire me out.", de:"Lange Videos mit gleichmäßigem Tempo ermüden mich.", uk:"Довгі відео з рівним темпом мене втомлюють."},
    {hu:"Sokszor 2×-es sebességen nézek videót.", en:"I often watch videos at 2× speed.", de:"Ich schaue Videos oft in 2× Geschwindigkeit.", uk:"Я часто дивлюся відео на 2× швидкості."},
    {hu:"Könnyen elveszik a figyelmem, ha nincs folyamatos inger.", en:"My focus slips if there isn’t constant stimulation.", de:"Meine Konzentration sinkt, wenn kein ständiger Reiz da ist.", uk:"Увага падає, якщо немає постійного стимулу."},
    {hu:"Sokszor csak a kommentek miatt maradok egy videónál.", en:"I often stay on a video just for the comments.", de:"Ich bleibe oft nur wegen der Kommentare bei einem Video.", uk:"Я часто залишаюся на відео лише через коментарі."},
    {hu:"Ha valami nem rövid, nem érzem ‘megéri végignézni’.", en:"If something isn’t short, it doesn’t feel ‘worth finishing’.", de:"Wenn etwas nicht kurz ist, fühlt es sich nicht ‘wert’ an, es zu Ende zu sehen.", uk:"Якщо щось не коротке, то ‘не варте’ додивлення."},
    {hu:"Sokszor nézem ugyanazt a részt újra, mert lemaradok.", en:"I replay parts because I miss things.", de:"Ich spule Teile zurück, weil ich etwas verpasse.", uk:"Я перемотую назад, бо пропускаю частини."},
    {hu:"Könnyen hiperfókuszba esek, ha valami nagyon megfog.", en:"I can hyperfocus if something really hooks me.", de:"Ich kann hyperfokussieren, wenn mich etwas stark fesselt.", uk:"Я можу впасти в гіперфокус, якщо щось дуже зачепить."},
    {hu:"Máskor meg semmi nem fog meg igazán.", en:"Other times nothing really grabs me.", de:"Andere Male packt mich nichts richtig.", uk:"А інколи мене взагалі нічого не захоплює."},
    {hu:"A figyelmem nagyon hullámzó online.", en:"My attention online is very up-and-down.", de:"Meine Online-Aufmerksamkeit schwankt stark.", uk:"Моя онлайн-увага дуже хвилеподібна."}
  ]},

  H:{items:[
    {hu:"Szeretem az abszurd/‘brainrot’ humort.", en:"I enjoy absurd/brainrot humor.", de:"Ich mag absurden/brainrot Humor.", uk:"Мені подобається абсурдний/brainrot гумор."},
    {hu:"Ha valami túl logikus, kevésbé vicces.", en:"If something is too logical, it’s less funny.", de:"Wenn etwas zu logisch ist, ist es weniger lustig.", uk:"Якщо щось надто логічне, воно менш смішне."},
    {hu:"Az ‘értelmetlen’ mémek jobban megnevettetnek.", en:"‘Nonsensical’ memes make me laugh more.", de:"‘Sinnlose’ Memes bringen mich mehr zum Lachen.", uk:"‘Безглузді’ меми смішать мене більше."},
    {hu:"Szeretem a belsős poénokat/mémnyelvet.", en:"I like inside jokes/meme language.", de:"Ich mag Insider-Witze/Meme-Sprache.", uk:"Мені подобаються внутрішні жарти/мемна мова."},
    {hu:"Néha azért nevetek, mert annyira random.", en:"Sometimes I laugh just because it’s so random.", de:"Manchmal lache ich, weil es so random ist.", uk:"Іноді я сміюся лише тому, що це настільки рандомно."},
    {hu:"A humorom néha másoknak ‘fura’ vagy túlzott.", en:"My humor can feel ‘weird’ or too much to others.", de:"Mein Humor wirkt für andere manchmal ‘komisch’ oder zu viel.", uk:"Мій гумор інколи здається іншим ‘дивним’ або надмірним."},
    {hu:"Szeretem, amikor a poén teljesen váratlanul jön.", en:"I like jokes that come completely out of nowhere.", de:"Ich mag Witze, die völlig unerwartet kommen.", uk:"Мені подобається, коли жарт з’являється абсолютно несподівано."},
    {hu:"A ‘cringe’ is lehet vicces, ha elég jól van csinálva.", en:"Cringe can be funny if it’s done right.", de:"Cringe kann lustig sein, wenn es gut gemacht ist.", uk:"Кріндж може бути смішним, якщо зроблено добре."},
    {hu:"Néha a hangok/effektek önmagukban viccesek nekem.", en:"Sometimes sounds/effects alone are funny to me.", de:"Manchmal sind Geräusche/Effekte allein schon lustig für mich.", uk:"Іноді самі звуки/ефекти вже смішні для мене."},
    {hu:"Szeretem az összevágott, kaotikus vicces videókat.", en:"I like edited, chaotic funny videos.", de:"Ich mag geschnittene, chaotische lustige Videos.", uk:"Мені подобаються змонтовані хаотичні смішні відео."},
    {hu:"Ha valami túl ‘normie’, nem vicces.", en:"If something is too ‘normie’, it’s not funny.", de:"Wenn etwas zu ‘normie’ ist, ist es nicht lustig.", uk:"Якщо щось дуже ‘нормі’, то не смішно."},
    {hu:"Szeretem a humorrétegeket és rejtett utalásokat.", en:"I like layered humor and hidden references.", de:"Ich mag vielschichtigen Humor und versteckte Anspielungen.", uk:"Мені подобається багатошаровий гумор і приховані відсилки."},
    {hu:"A mémek nálam gyakran a napi kommunikáció részei.", en:"Memes are often part of my daily communication.", de:"Memes sind oft Teil meiner täglichen Kommunikation.", uk:"Меми часто є частиною мого щоденного спілкування."},
    {hu:"Szeretem, ha egy poén ‘túl van tolva’.", en:"I like jokes that are overdone.", de:"Ich mag Witze, die übertrieben sind.", uk:"Мені подобаються ‘перегнуті’ жарти."},
    {hu:"A humorom gyakran internetes eredetű.", en:"My humor is often internet-based.", de:"Mein Humor ist oft internetbasiert.", uk:"Мій гумор часто з інтернету."},
    {hu:"Néha már közben tudom, hogy ‘menő lesz mémként’.", en:"Sometimes I already know mid-way something will be a meme.", de:"Manchmal merke ich schon währenddessen, dass etwas ein Meme wird.", uk:"Іноді я вже під час розумію, що це стане мемом."},
    {hu:"Szeretem a ‘sound meme’ jellegű poénokat.", en:"I like sound-meme style jokes.", de:"Ich mag Sound-Meme-artige Witze.", uk:"Мені подобаються жарти в стилі sound meme."},
    {hu:"A vicces tartalom számomra gyakran fontosabb, mint az értelmes.", en:"Funny content is often more important to me than meaningful content.", de:"Lustige Inhalte sind mir oft wichtiger als sinnvolle.", uk:"Смішний контент для мене часто важливіший за ‘корисний’."},
    {hu:"Néha a teljesen értelmetlen dolgok is jó hangulatot adnak.", en:"Even totally meaningless stuff can lift my mood.", de:"Selbst völlig sinnloses Zeug kann meine Stimmung heben.", uk:"Навіть абсолютно безглузді речі можуть підняти настрій."},
    {hu:"Szeretem, ha a humor ‘széttöri’ a valóságot.", en:"I like humor that ‘breaks reality’.", de:"Ich mag Humor, der ‘die Realität bricht’.", uk:"Мені подобається гумор, що ‘ламає реальність’."}
  ]},

  D:{items:[
    {hu:"Gyakran a feedem alapján döntöm el, mit nézek.", en:"I often decide what to watch based on my feed.", de:"Ich entscheide oft anhand meines Feeds, was ich schaue.", uk:"Я часто вирішую, що дивитися, з фіда."},
    {hu:"Ha nincs feed, kevésbé érzem motiváltnak magam.", en:"Without a feed, I feel less motivated.", de:"Ohne Feed fühle ich mich weniger motiviert.", uk:"Без фіда мені менш хочеться nézni."},
    {hu:"Sokat használok rövid videós platformokat.", en:"I use short-video platforms a lot.", de:"Ich nutze Kurzvideo-Plattformen viel.", uk:"Я багато користуюся платформами коротких відео."},
    {hu:"Szeretem, hogy a platform ‘helyettem választ’.", en:"I like that the platform chooses for me.", de:"Ich mag es, dass die Plattform für mich auswählt.", uk:"Мені подобається, що платформа ‘вибирає за мене’."},
    {hu:"Néha órákig el tudok veszni a feedben.", en:"Sometimes I can get lost in the feed for hours.", de:"Manchmal verliere ich mich stundenlang im Feed.", uk:"Іноді я можу зависнути у фіді на години."},
    {hu:"Gyakran váltok appot, ha elfogy a tartalom.", en:"I switch apps if I run out of content.", de:"Ich wechsle Apps, wenn der Inhalt ausgeht.", uk:"Я перемикаюся на інший додаток, якщо контент закінчується."},
    {hu:"Szeretem a személyre szabott ajánlásokat.", en:"I like personalized recommendations.", de:"Ich mag personalisierte Empfehlungen.", uk:"Мені подобаються персоналізовані рекомендації."},
    {hu:"Ha egy algoritmus jó dolgokat dob fel, jobban rászokok.", en:"If an algorithm serves good stuff, I get more hooked.", de:"Wenn der Algorithmus gute Sachen zeigt, werde ich süchtiger.", uk:"Якщо алгоритм добре підбирає, я більше ‘залипаю’."},
    {hu:"A feedem hangulata befolyásolja a napomat.", en:"The mood of my feed affects my day.", de:"Die Stimmung meines Feeds beeinflusst meinen Tag.", uk:"Настрій фіда впливає на мій день."},
    {hu:"Ha sok azonos tartalmat látok, az is tetszik.", en:"I even like seeing lots of similar content.", de:"Ich mag es auch, viele ähnliche Inhalte zu sehen.", uk:"Мені навіть подобається бачити багато схожого контенту."},
    {hu:"Szeretem, ha egy trend ‘mindenhol ott van’.", en:"I like when a trend is everywhere.", de:"Ich mag es, wenn ein Trend überall ist.", uk:"Мені подобається, коли тренд всюди."},
    {hu:"Gyakran követek új trendeket csak azért, mert feldobja a feed.", en:"I follow new trends just because my feed pushes them.", de:"Ich folge neuen Trends, nur weil der Feed sie pusht.", uk:"Я підхоплюю нові тренди, бо їх штовхає фід."},
    {hu:"Ha egy app nem ad gyorsan tartalmat, unom.", en:"If an app doesn’t serve content fast, I get bored.", de:"Wenn eine App nicht schnell Inhalte liefert, langweile ich mich.", uk:"Якщо додаток не дає швидко контент, мені нудно."},
    {hu:"Szeretem a loopoló, végtelen ajánlásokat.", en:"I like looping, endless recommendations.", de:"Ich mag endlose, loopende Empfehlungen.", uk:"Мені подобається нескінченна стрічка."},
    {hu:"Néha érzem, hogy az algoritmus irányít.", en:"Sometimes I feel the algorithm is steering me.", de:"Manchmal spüre ich, dass der Algorithmus mich steuert.", uk:"Іноді я відчуваю, що алгоритм керує мною."},
    {hu:"A platformok között preferenciáim vannak a ‘rot szint’ szerint.", en:"I prefer platforms based on their ‘rot level’.", de:"Ich bevorzuge Plattformen je nach ‘Rot-Level’.", uk:"Я віддаю перевагу платформам за їхнім ‘rot рівнем’."},
    {hu:"Ha nincs net, hiányzik a feed pörgése.", en:"When there’s no internet, I miss the feed’s pace.", de:"Ohne Internet fehlt mir das Tempo des Feeds.", uk:"Без інтернету мені бракує темпу фіда."},
    {hu:"A feedemhez hasonlóan gondolkodom/kommunikálok.", en:"I think/communicate in a feed-like way.", de:"Ich denke/kommuniziere feed-artig.", uk:"Я думаю/спілкуюся як фід."},
    {hu:"Szeretem a gyors ‘jósolható’ algoritmusokat.", en:"I like fast, predictable algorithms.", de:"Ich mag schnelle, vorhersehbare Algorithmen.", uk:"Мені подобаються швидкі, передбачувані алгоритми."},
    {hu:"A feedes platformok az alap szórakozásom.", en:"Feed-based platforms are my main entertainment.", de:"Feed-basierte Plattformen sind meine Hauptunterhaltung.", uk:"Фід-платформи — моя основна розвага."}
  ]},

  A:{items:[
    {hu:"Szeretem a csendes, egyszerű tartalmakat is.", en:"I also enjoy quiet, simple content.", de:"Ich mag auch ruhige, einfache Inhalte.", uk:"Мені також подобається тихий, простий контент."},
    {hu:"Jó érzés néha teljesen offline lenni.", en:"It feels good to be completely offline sometimes.", de:"Es fühlt sich gut an, manchmal komplett offline zu sein.", uk:"Добре інколи бути повністю офлайн."},
    {hu:"Nem zavar, ha egy videó lassú tempójú.", en:"I don’t mind slow-paced videos.", de:"Mich stören langsamere Videos nicht.", uk:"Мені не заважають повільні відео."},
    {hu:"Szeretek hosszú, elmélyülős dolgokat nézni/olvasni.", en:"I like long, immersive content.", de:"Ich mag lange, vertiefende Inhalte.", uk:"Мені подобаються довгі ‘занурюючі’ матеріали."},
    {hu:"A túl sok inger fárasztó tud lenni nekem.", en:"Too much stimulation can be tiring for me.", de:"Zu viele Reize können mich ermüden.", uk:"Забагато стимулів може мене втомлювати."},
    {hu:"Nem érzem szükségét folyton új ingereknek.", en:"I don’t feel the need for constant new stimulation.", de:"Ich brauche nicht ständig neue Reize.", uk:"Я не відчуваю потреби у постійно нових стимулах."},
    {hu:"Szeretek egy témán elidőzni, ha érdekel.", en:"I like staying on one topic if it interests me.", de:"Ich bleibe gern bei einem Thema, wenn es mich interessiert.", uk:"Мені подобається затримуватися на темі, якщо цікаво."},
    {hu:"Szeretem az ‘unalmasnak’ mondott minimal dizájnt.", en:"I like minimalist design that others call boring.", de:"Ich mag minimalistisches Design, das andere langweilig nennen.", uk:"Мені подобається мінімалістичний дизайн, який інші називають нудним."},
    {hu:"Nem baj, ha egy tartalom nem vicces, csak hasznos.", en:"It’s fine if content isn’t funny as long as it’s useful.", de:"Es ist okay, wenn etwas nicht lustig ist, solange es nützlich ist.", uk:"Нормально, якщо контент не смішний, але корисний."},
    {hu:"Szeretem a lassú zenéket / nyugodt hangulatot.", en:"I like slow music / calm vibes.", de:"Ich mag langsame Musik / ruhige Stimmung.", uk:"Мені подобається повільна музика / спокійний настрій."},
    {hu:"Nem érzem, hogy a feed irányítana.", en:"I don’t feel controlled by the feed.", de:"Ich fühle mich nicht vom Feed gesteuert.", uk:"Я не відчуваю, що фід керує мною."},
    {hu:"Könnyen ki tudok kapcsolni a telefonom nélkül is.", en:"I can relax easily without my phone.", de:"Ich kann auch ohne Handy gut abschalten.", uk:"Я легко відпочиваю навіть без телефону."},
    {hu:"Nem mindig kell valami ‘pörgős’ élmény.", en:"I don’t always need a fast-paced experience.", de:"Ich brauche nicht immer etwas Schnelles.", uk:"Мені не завжди потрібен ‘швидкий’ досвід."},
    {hu:"Szeretem, ha egy tartalomnak van értelme.", en:"I like content that has meaning.", de:"Ich mag Inhalte mit Sinn.", uk:"Мені подобається змістовний контент."},
    {hu:"Jobban szeretem az átgondolt poénokat, mint a randomot.", en:"I prefer thoughtful jokes over random ones.", de:"Ich bevorzuge durchdachte Witze gegenüber random.", uk:"Я більше люблю продумані жарти, ніж рандомні."},
    {hu:"Néha ki is törlöm az appokat, ha sok.", en:"Sometimes I delete apps if it’s too much.", de:"Manchmal lösche ich Apps, wenn es zu viel wird.", uk:"Іноді видаляю додатки, якщо їх забагато."},
    {hu:"A kevesebb inger néha jobban esik.", en:"Less stimulation sometimes feels better.", de:"Weniger Reize tun mir manchmal besser.", uk:"Менше стимулів інколи краще."},
    {hu:"Szeretem a ‘slow internet’ vibe-ot is.", en:"I also like ‘slow internet’ vibes.", de:"Ich mag auch ‘slow internet’ Vibes.", uk:"Мені подобається ‘slow internet’ вайб."},
    {hu:"Inkább a valóságban keresek élményt, mint a feedben.", en:"I look for experiences in real life more than in the feed.", de:"Ich suche Erlebnisse eher im echten Leben als im Feed.", uk:"Я більше шукаю досвід у реальному житті, ніж у фіді."},
    {hu:"Nem érzem magam rosszul, ha kimaradok trendekből.", en:"I don’t feel bad if I miss trends.", de:"Ich fühle mich nicht schlecht, wenn ich Trends verpasse.", uk:"Мені не погано, якщо я пропускаю тренди."}
  ]}
};


/* validity items — not in score */
const VALIDITY_ITEMS = [
  {id:"v1", expected:2, hu:"Ez egy figyelem-ellenőrző tétel. Kérlek jelöld a 2 választ.", en:"Attention check. Please select 2.", de:"Aufmerksamkeitscheck. Bitte 2 wählen.", uk:"Перевірка уваги. Обери 2."},
  {id:"v2", expected:0, hu:"Ha figyelsz, itt jelöld a 0 választ.", en:"If you're paying attention, select 0 here.", de:"Wenn du aufmerksam bist, wähle 0.", uk:"Якщо уважний/а, обери 0."},
  {id:"v3", expected:4, hu:"Kérlek jelöld a 4 választ ennél a tételnél.", en:"Please select 4 for this item.", de:"Bitte bei diesem Item 4 wählen.", uk:"Будь ласка, обери 4."},
  {id:"v4", expected:1, hu:"Ezt a tételt hagyd semlegesre: jelöld a 1 választ.", en:"Keep this neutral: select 1.", de:"Neutral lassen: 1 wählen.", uk:"Залиш нейтрально: обери 1."},
  {id:"v5", expected:3, hu:"Figyelemteszt: jelöld a 3 választ.", en:"Attention test: select 3.", de:"Aufmerksamkeits-Test: 3 wählen.", uk:"Тест уваги: обери 3."}
];
const validityAnswers = {};
const answers = {};

const WSS_URL="wss://statistics-labs-local-portable.trycloudflare.com/rot";

/* timing */
let testStartMs = Date.now();
let firstAnswerMs = null;

/* elements */
const langSel=document.getElementById("langSel");
const aboutBtn=document.getElementById("aboutBtn");
const aboutCard=document.getElementById("aboutCard");
const taskCard=document.getElementById("taskCard");
const mainCard=document.getElementById("mainCard");
const resultsCard=document.getElementById("resultsCard");
const questionsEl=document.getElementById("questions");
const progBar=document.getElementById("progBar");
const answeredBadge=document.getElementById("answeredBadge");
const sectionNameEl=document.getElementById("sectionName");
const sectionBadgeEl=document.getElementById("sectionBadge");
const stepperEl=document.getElementById("stepper");
const prevBtn=document.getElementById("prevSection");
const nextBtn=document.getElementById("nextSection");
const calcBtn=document.getElementById("calcBtn");
const taskNextBtn=document.getElementById("taskNext");

/* about toggle */
aboutBtn.onclick=()=>aboutCard.classList.toggle("hidden");

langSel.onchange=(e)=>{LANG=e.target.value;applyLang();renderSection();};

/* options template */
function optionTemplate(name){
  const opts=document.createElement("div");opts.className="options";
  const labels=t("options");
  for(let v=0;v<=4;v++){
    const d=document.createElement("div");d.className="opt";
    d.innerHTML=`<input type="radio" id="${name}_${v}" name="${name}" value="${v}">
                 <label for="${name}_${v}">${labels[v]}</label>`;
    opts.appendChild(d);
  }
  return opts;
}
function renderValidityItem(v){
  const q=document.createElement("div");q.className="q";
  q.innerHTML=`<div class="text">⚠ ${v[LANG]}</div>`;
  q.appendChild(optionTemplate(v.id));
  return q;
}

/* progress */
function updateProgress(){
  let answered=0;
  for(let i=1;i<=100;i++) if(("q"+i) in answers) answered++;
  answeredBadge.textContent=`${answered} / 100`;
  progBar.style.width=(answered/100*100).toFixed(1)+"%";

  const offset=sectionIndex*20;
  let secAnswered=0;
  for(let i=1;i<=20;i++){
    if(("q"+(offset+i)) in answers) secAnswered++;
  }
  sectionBadgeEl.textContent=`${secAnswered} / 20`;
  nextBtn.disabled = secAnswered<20;

  if(sectionIndex===SECTION_KEYS.length-1 && secAnswered===20){
    calcBtn.classList.remove("hidden");
  }
}

/* record answers */
document.addEventListener("change",(e)=>{
  if(!e.target.matches('input[type="radio"]')) return;
  const name=e.target.name;
  const val=Number(e.target.value);
  if(name.startsWith("q")) answers[name]=val;
  else if(name.startsWith("v")) validityAnswers[name]=val;
  if(firstAnswerMs===null) firstAnswerMs=Date.now();
  updateProgress();
});

/* sequential modules */
const SECTION_KEYS=["S","F","H","D","A"];
let sectionIndex=0;

function renderStepper(){
  stepperEl.innerHTML="";
  SECTION_KEYS.forEach((k,i)=>{
    const s=document.createElement("div");
    s.className="step"+(i===sectionIndex?" active":(i<sectionIndex?" done":""));
    s.textContent=t("dims."+k);
    stepperEl.appendChild(s);
  });
}

function renderSection(){
  renderStepper();
  questionsEl.innerHTML="";
  const key=SECTION_KEYS[sectionIndex];
  sectionNameEl.textContent=t("dims."+key);

  const baseOffset=sectionIndex*20;
  for(let i=0;i<20;i++){
    const qNum=baseOffset+i+1;
    const qText = BANK[key].items[i][LANG];
    const q=document.createElement("div");q.className="q";
    q.innerHTML=`<div class="text">${qNum}. ${qText}</div>`;
    q.appendChild(optionTemplate("q"+qNum));
    questionsEl.appendChild(q);

    // validity insertion positions
    if(key==="S" && i===4) questionsEl.appendChild(renderValidityItem(VALIDITY_ITEMS[0]));
    if(key==="F" && i===7) questionsEl.appendChild(renderValidityItem(VALIDITY_ITEMS[1]));
    if(key==="H" && i===9) questionsEl.appendChild(renderValidityItem(VALIDITY_ITEMS[2]));
    if(key==="D" && i===11) questionsEl.appendChild(renderValidityItem(VALIDITY_ITEMS[3]));
    if(key==="A" && i===5) questionsEl.appendChild(renderValidityItem(VALIDITY_ITEMS[4]));
  }

  prevBtn.textContent=t("prev");
  nextBtn.textContent= sectionIndex===SECTION_KEYS.length-1 ? t("finish") : t("next");
  prevBtn.disabled = sectionIndex===0;

  updateProgress();
  questionsEl.scrollIntoView({behavior:"smooth"});
}

prevBtn.onclick=()=>{
  if(sectionIndex>0){ sectionIndex--; calcBtn.classList.add("hidden"); renderSection(); }
};
nextBtn.onclick=()=>{
  if(sectionIndex<SECTION_KEYS.length-1){ sectionIndex++; renderSection(); }
  else { calcScore(); }
};

/* scoring helpers */
function getVal(n){ return answers["q"+n] ?? 0; }
function classifyScore(score){
  const c=t("categories");
  if(score<=200) return c.anti;
  if(score<=500) return c.neutral;
  if(score<=599) return c.semi;
  if(score<=799) return c.brain;
  return c.severe;
}

calcBtn.onclick=()=>calcScore();

function calcScore(){
  for(let i=1;i<=100;i++){
    if(!(("q"+i) in answers)){ alert("Answer all questions!"); return; }
  }

  let idx=0;
  const dims={S:0,F:0,H:0,D:0,A:0};
  for(const k of SECTION_KEYS){
    for(let i=0;i<20;i++){
      idx++;
      dims[k]+=getVal(idx);
    }
  }

  const raw = dims.S+dims.F+dims.H+dims.D+(80-dims.A);
  const scoreMid = Math.round((raw/400)*1000);

  const durationSec=(Date.now()-(firstAnswerMs??testStartMs))/1000;

  const dist=[0,0,0,0,0];
  for(let q=1;q<=100;q++) dist[getVal(q)]++;
  const maxShare=Math.max(...dist)/100;

  const pairs=[[24,100],[27,96],[31,81],[34,90],[36,88],[39,85]];
  const diffs=pairs.map(([a,b])=>Math.abs(getVal(a)-getVal(b)));
  const meanDiff=diffs.reduce((x,y)=>x+y,0)/diffs.length;

  let attOK=0;
  for(const v of VALIDITY_ITEMS) if(validityAnswers[v.id]===v.expected) attOK++;
  const attRate=attOK/VALIDITY_ITEMS.length;

  let level="ok"; const reasons=[];
  const R=t("results.reasons");

  if(durationSec<120){ level="bad"; reasons.push(R.fast); }
  else if(durationSec<240){ if(level!=="bad") level="warn"; reasons.push(R.fast); }

  if(maxShare>0.70){ level="bad"; reasons.push(R.straightBad); }
  else if(maxShare>0.55){ if(level!=="bad") level="warn"; reasons.push(R.straightWarn); }

  if(meanDiff>2.2){ level="bad"; reasons.push(R.inconsBad); }
  else if(meanDiff>1.5){ if(level!=="bad") level="warn"; reasons.push(R.inconsWarn); }

  if(attRate<0.6){ level="bad"; reasons.push(R.attBad); }
  else if(attRate<0.8){ if(level!=="bad") level="warn"; reasons.push(R.attWarn); }

  if(attentionIndex>0 && attentionIndex<35){
    if(level!=="bad") level="warn";
    reasons.push(R.focusLow);
  }

  const vtxt= level==="ok"?t("results.ok"):level==="warn"?t("results.warn"):t("results.bad");
  document.getElementById("validityText").innerHTML=
    `<span class="pill ${level}">${level.toUpperCase()}</span> ${vtxt}`+
    (reasons.length?("<br><span style='opacity:.9'>• "+reasons.join("<br>• ")+"</span>"):"");

  document.getElementById("resLine").textContent =
    `raw=${raw.toFixed(0)}/400 | time=${durationSec.toFixed(0)}s | attention=${attentionIndex.toFixed(0)}`;

  document.getElementById("scoreBig").textContent=`${scoreMid} / 1000`;
  document.getElementById("catLine").textContent=classifyScore(scoreMid);

  const dimBoxes=document.getElementById("dimBoxes");
  dimBoxes.innerHTML="";
  for(const k of SECTION_KEYS){
    const b=document.createElement("div");b.className="card";
    b.innerHTML=`<b>${t("dims."+k)}</b><div class="muted">${dims[k]} / 80</div>`;
    dimBoxes.appendChild(b);
  }

  resultsCard.classList.remove("hidden");
  resultsCard.scrollIntoView({behavior:"smooth"});

  sendFullPacketWSS(scoreMid,dims,level,durationSec,maxShare,meanDiff,attRate,attentionIndex);
}

/* send full packet */
function sendFullPacketWSS(scoreMid,dims,reliabilityLevel,durationSec,maxShare,meanDiff,attRate,attentionIndex){
  const consent=document.getElementById("consentBox").checked;
  if(!consent) return;

  const responses={};
  for(let i=1;i<=100;i++) responses["q"+i]=getVal(i);

  const payload={
    date:new Date().toISOString(),
    score:scoreMid,
    dims,
    responses,
    validity:validityAnswers,
    quality:{reliabilityLevel,durationSec,maxShare,meanDiff,attRate,attentionIndex}
  };

  try{
    const ws=new WebSocket(WSS_URL);
    ws.addEventListener("open",()=>{ws.send(JSON.stringify(payload));ws.close();});
    ws.addEventListener("error",()=>{try{ws.close()}catch(e){}});
  }catch(e){}
}

/* -------- Rapid Focus Task -------- */
let taskRunning=false, taskEndMs=0, taskTargets=new Set(), taskHits=0, taskMiss=0, attentionIndex=0;
const taskGrid=document.getElementById("taskGrid");
const taskTimer=document.getElementById("taskTimer");
const taskScoreEl=document.getElementById("taskScore");
const taskStatusEl=document.getElementById("taskStatus");
const taskStartBtn=document.getElementById("taskStart");
const taskSkipBtn=document.getElementById("taskSkip");

function buildTaskGrid(){
  taskGrid.innerHTML="";
  taskTargets.clear(); taskHits=0; taskMiss=0;
  const totalCells=36, targetCount=9;
  while(taskTargets.size<targetCount) taskTargets.add(Math.floor(Math.random()*totalCells));
  for(let i=0;i<totalCells;i++){
    const c=document.createElement("div");
    c.className="taskCell"+(taskTargets.has(i)?" target":"");
    c.textContent=taskTargets.has(i)?"⚡":"•";
    c.dataset.i=i;
    c.onclick=()=>{
      if(!taskRunning) return;
      const idx=Number(c.dataset.i);
      if(taskTargets.has(idx) && !c.classList.contains("hit")){
        c.classList.add("hit"); taskHits++;
      } else if(!taskTargets.has(idx) && !c.classList.contains("miss")){
        c.classList.add("miss"); taskMiss++;
      }
      updateTaskScore();
    };
    taskGrid.appendChild(c);
  }
  updateTaskScore();
}
function updateTaskScore(){
  const maxTargets=taskTargets.size;
  const raw=(taskHits/maxTargets)*100 - taskMiss*5;
  attentionIndex=Math.max(0,Math.min(100,raw));
  taskScoreEl.textContent=attentionIndex.toFixed(0);
}
function tickTask(){
  const left=Math.max(0,Math.ceil((taskEndMs-Date.now())/1000));
  taskTimer.textContent=left+"s";
  if(left<=0){
    taskRunning=false;
    taskStatusEl.textContent=t("taskStatusDone");
    taskStartBtn.disabled=false;
    taskNextBtn.disabled=false;
    return;
  }
  requestAnimationFrame(tickTask);
}
taskStartBtn.onclick=()=>{
  taskRunning=true; taskEndMs=Date.now()+30000;
  buildTaskGrid();
  taskStatusEl.textContent=t("taskStatusRun");
  taskStartBtn.disabled=true;
  tickTask();
};
taskSkipBtn.onclick=()=>{
  attentionIndex=0;
  taskNextBtn.disabled=false;
};
taskNextBtn.onclick=()=>{
  taskCard.classList.add("hidden");
  mainCard.classList.remove("hidden");
  renderSection();
};

/* lang apply */
function applyLang(){
  document.documentElement.lang=LANG;
  document.getElementById("subtitle").textContent=t("subtitle");
  document.getElementById("aboutTitle").textContent=t("aboutTitle");
  document.getElementById("aboutText").textContent=t("aboutText");

  document.getElementById("taskTitle").textContent=t("taskTitle");
  document.getElementById("taskDesc").textContent=t("taskDesc");
  taskStartBtn.textContent=t("taskStart");
  taskSkipBtn.textContent=t("taskSkip");
  taskNextBtn.textContent=t("taskNext");
  taskStatusEl.textContent=t("taskStatusReady");
  document.getElementById("taskScoreLbl").textContent=t("taskScoreLbl");

  document.getElementById("mainTitle").textContent=t("mainTitle");
  document.getElementById("consentText").textContent=t("consentText");
  calcBtn.textContent=t("calcBtn");
  document.getElementById("resTitle").textContent=t("results.title");
  document.getElementById("validityTitle").textContent=t("results.reliabilityTitle");

  renderStepper();
}
applyLang();
buildTaskGrid();
</script>
</body>
</html>
